<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    *,
    :after,
    :before {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      border: none;
      background-color: inherit;
      outline: none;
    }

    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #202020;
    }

    .main {
      width: 70%;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      background-color: #eee;
      box-shadow: 0 0 10rem .5rem #c3c3c3;
      border-radius: 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
    }

    .header button {
      padding: .25rem 2rem;
      font-size: 1rem;
      background-color: #ddd;
      border-radius: 1rem;
    }

    .main .chat {
      width: 100%;
      height: 100%;
      background-color: #eee;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 0 12rem -2.5rem black;
      font-size: 1.75rem;
    }

    .main .input {
      width: 100%;
      height: 4rem;
      border-radius: 1rem;
      display: flex;
      gap: 1rem;
      font-size: 1.75rem;
      background-color: transparent;
    }

    .main .input input {
      /* background-color: #ddd; */
      border: solid 1px gray;
      border-radius: 1rem;
      width: 100%;
      height: 100%;
      padding: 0 1rem;
      font-size: 1.25rem;
      background-color: #eee;
    }

    .input button {
      width: 5rem;
      font-size: 1.25rem;
      background-color: #202020;
      color: #eee;
      border-radius: 1rem;
    }

    input:focus-within {
      outline: solid .25rem #08f;
    }

    @media (max-width: 800px) {
      .main {
        width: 100%;
        border-radius: 0;
      }
    }
  </style>
</head>

<body>
  <div class="main">
    <div class="header">
      <h2>충렬AI</h2>
      <button>리셋</button>
    </div>
    <div class="chat" id="output"></div>
    <div class="input">
      <input id="input" type="text" placeholder="입력">
      <button id="generate">생성</button>
    </div>
  </div>

  <script type="module">
  const OPENAI_API_KEY = atob("c2stcHJvai14R0VONndvQVhrWldxUFBUcFM5WVctUEcxbXlaSUtVLTI2X3p2Vnl6UzFnUzdnQXVtR0xERDZ4bmFSall1MnQtOGFPZUltZkV5VFQzQmxia0ZKUmdHOVRPbVdWVVUtTXZYNWpOUHVjYVZ6ZVBjb0hfSURhUjlVa3JOeDRnZzc0M1dOTkFmVEM3N0xHbmF4WkwtT01RSlZpS2FtTUE=");

  let data = '';
  let dataprompt = '';

  async function generateContent() {
    const outputDiv = document.getElementById('output');

    try {
      const presetprompt =
        '짧게 2문장 이내로 대답해. ' +
        '너는 충렬고등학교 정보 ai입니다. ' +
        '학교와 관련된 질문에만 대답하시오, ' +
        '교실의 위치뿐만 아니라 어느 교실의 옆에 있는지도 말하시오\n' +
        '학교 정보:\n';

      const prompt = document.getElementById('input').value;

      const response = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
          model: 'gpt-4.1-mini',
          input: presetprompt + dataprompt + '질문: ' + prompt
        })
      });

      if (!response.ok) {
        const err = await response.text();
        throw new Error(err);
      }

      const result = await response.json();

      const text =
        result.output_text ||
        result.output?.[result.output.length - 1]?.content?.[0]?.text ||
        '응답을 생성하지 못했습니다.';
      console.log(result);

      outputDiv.textContent = text;

    } catch (error) {
      console.error('Error generating content:', error);
      outputDiv.textContent = 'Error: ' + error.message;
    }
  }

  function parseCSV(csvString) {
    const rows = csvString
      .split('\n')
      .map(row => row.trim())
      .filter(row => row.length > 0);

    return rows.map(row => {
      const fields = row.match(/(?:[^,"']+|"([^"]*)")+/g);
      return fields.map(field => {
        if (field.startsWith('"') && field.endsWith('"')) {
          return field.slice(1, -1).replace(/""/g, '"');
        }
        return field;
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const generateButton = document.getElementById('generate');

    generateButton.addEventListener('click', generateContent);

    fetch('https://raw.githubusercontent.com/CodingChung/schoolAI/refs/heads/main/data.csv')
      .then(res => {
        if (!res.ok) throw new Error(res.status);
        return res.text();
      })
      .then(text => {
        data = parseCSV(text);
        data.forEach(row => {
          dataprompt += `${row[0]}\n${row[1]}\n\n`;
        });
      })
      .catch(err => {
        console.error('CSV fetch failed:', err);
      });

    document.querySelector('input').addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        generateButton.click();
      }
    });
  });
</script>

</body>

</html>
